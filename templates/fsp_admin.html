<!DOCTYPE html>
<html lang="{{ lang }}" {% if lang == 'ar' %}dir="rtl"{% endif %}>
<head>
  <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
  <meta charset="UTF-8">
  <title>FSP Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

  <style>
    :root {
      --bg: #f3f4f6;
      --card: #ffffff;
      --ink: #111827;
      --muted: #6b7280;
      --line: #e5e7eb;
      --radius: 16px;
      --shadow-soft: 0 10px 30px rgba(0,0,0,0.06);
    }

    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--bg);
      color: var(--ink);
      margin: 0;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    /* ---------- HEADER ---------- */
    header {
      background-color: #ffffff;
      padding: 16px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }

    .header-left {
      display:flex;
      align-items:center;
      gap:12px;
    }

    .header-left img {
      height: 50px;
      object-fit: contain;
    }

    .scandroid-banner {
      flex: 1;
      text-align: center;
    }

    .scandroid-banner img {
      height: 80px;
      max-width: 60%;
      object-fit: contain;
      display: inline-block;
    }

    .right-controls {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .right-controls select {
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      background: #ffffff;
      font-weight: 600;
      cursor: pointer;
    }

    .logout-button {
      padding: 8px 14px;
      background-color: #dc3545;
      color: #ffffff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
    }

    .logout-button:hover {
      background-color: #b91c1c;
    }

    /* Online/Offline status pill */
    .status-pill {
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:700;
      border:1px solid transparent;
      user-select:none;
    }
    .status-pill.online {
      background:#e7f9ef;
      color:#0f5132;
      border-color:#b7ebcd;
    }
    .status-pill.offline {
      background:#fdecec;
      color:#842029;
      border-color:#f5c2c7;
    }

    /* ---------- MAIN LAYOUT ---------- */
    main {
      flex-grow: 1;
      padding: 24px 16px 40px 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 24px;
    }

    .sync-section {
      background: var(--card);
      padding: 24px 20px;
      border-radius: var(--radius);
      box-shadow: var(--shadow-soft);
      max-width: 520px;
      width: 100%;
      text-align: left;
      border: 1px solid var(--line);
    }

    .sync-section h2 {
      margin: 0 0 16px 0;
      font-size: 1.25rem;
      color: var(--ink);
    }

    .sync-section p {
      margin: 0 0 12px 0;
      color: var(--muted);
      font-size: 0.95rem;
    }

    .sync-section + .sync-section {
      margin-top: 4px; /* small visual gap; main already handles spacing */
    }

    /* ---------- BUTTONS ---------- */
    #syncBtn, #scanBtn {
      display: block;
      width: 100%;
      padding: 14px 18px;
      font-size: 1rem;
      border: none;
      border-radius: 14px;
      cursor: pointer;
      margin-bottom: 10px;
      font-weight: 700;
      box-shadow: var(--shadow-soft);
      transition: transform 0.05s ease, box-shadow 0.1s ease, background-color 0.1s ease;
    }

    #syncBtn {
      background-color: #1d4ed8;
      color: white;
    }
    #syncBtn:hover:not(:disabled) {
      background-color: #1e40af;
      transform: translateY(-1px);
    }
    #syncBtn:disabled {
      opacity: 0.8;
      cursor: not-allowed;
    }

    #scanBtn {
      background-color: #16a34a;
      color: white;
      margin-top: 18px; /* clearer separation from Sync */
    }
    #scanBtn:hover {
      background-color: #15803d;
      transform: translateY(-1px);
    }

    #generateCsvBtn {
      width: 100%;
      background-color:#15c4fa;
      color:#333;
      padding:12px 16px;
      border:none;
      border-radius:12px;
      font-size:1rem;
      cursor:pointer;
      font-weight:700;
      margin-top:8px;
    }
    #generateCsvBtn:hover {
      background-color:#15c4faaf;
    }

    #submitCsvBtn {
      width: 100%;
      background-color:#cf3398;
      color:white;
      padding:12px 16px;
      border:none;
      border-radius:12px;
      font-size:1rem;
      cursor:pointer;
      font-weight:700;
      margin-top:4px;
    }
    #submitCsvBtn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    #submitCsvBtn:not(:disabled):hover {
      background-color:#cf33988e;
    }

    #statusMessage {
      font-size: 0.95rem;
      margin-top: 8px;
      color: var(--muted);
    }

    #csv-status {
      font-size: 0.95rem;
      color: var(--muted);
    }

    #csv-count {
      font-weight: 700;
      margin-left: 4px;
      color: #111827;
    }

    #submit-status {
      margin-top: 10px;
      font-size: 0.95rem;
      color: var(--ink);
    }

    /* Last synced card */
    .last-synced-card {
      background: #ffffff;
      padding: 10px 14px;
      border-radius: 12px;
      max-width: 520px;
      width: 100%;
      box-shadow: var(--shadow-soft);
      border: 1px solid var(--line);
      font-size: 0.9rem;
      color: var(--muted);
    }

    /* Spinner */
    .spinner {
      border: 3px solid #e5e7eb;
      border-top: 3px solid #ffffff;
      border-radius: 50%;
      width: 16px;
      height: 16px;
      animation: spin 0.8s linear infinite;
      display: inline-block;
      vertical-align: middle;
      margin-right: 8px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* ---------- OFFLINE POPUP ---------- */
    #offline-popup {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #fff3cd;
      color: #856404;
      padding: 16px 24px;
      font-weight: bold;
      border: 1px solid #ffeeba;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      z-index: 9999;
      max-width: 90%;
      text-align: center;
    }

    #offline-popup button {
      position: absolute;
      top: 4px;
      right: 8px;
      background: none;
      border: none;
      font-size: 20px;
      font-weight: bold;
      cursor: pointer;
      color: #856404;
    }

    /* ---------- FOOTER ---------- */
    footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 18px 16px 18px;
      font-size: 0.9rem;
      background-color: #f9fafb;
      border-top: 1px solid #e5e7eb;
      flex-wrap: wrap;
    }

    .footer-left, .footer-right {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .guide-button {
      background-color: #d62828;
      color: #fff;
      text-decoration: none;
      padding: 8px 14px;
      border-radius: 6px;
      font-weight: bold;
      transition: background-color 0.2s ease;
      max-width: fit-content;
      font-size: 0.9rem;
    }

    .guide-button:hover {
      background-color: #b81f1f;
    }

    .footer-right a {
      color: #1d4ed8;
      text-decoration: none;
    }

    .footer-right a:hover {
      text-decoration: underline;
    }

    /* ---------- MOBILE ---------- */
    @media (max-width: 576px) {
      header {
        flex-direction: column;
        justify-content: center;
        align-items: center;
        gap: 8px;
        padding: 12px;
      }

      .header-left img {
        height: 40px;
      }

      .scandroid-banner img {
        height: 60px;
        max-width: 80%;
      }

      .right-controls {
        flex-direction: row;
        justify-content: center;
        width: 100%;
        gap: 8px;
      }

      main {
        padding: 20px 12px 28px 12px;
      }

      .sync-section {
        padding: 20px 16px;
        max-width: 430px;
      }

      /* Footer duplicated for mobile (kept as in original) */
      footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 18px 16px 18px;
        font-size: 0.9rem;
        background-color: #f9fafb;
        border-top: 1px solid #e5e7eb;
        flex-wrap: wrap;
      }

      .footer-left, .footer-right {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
    }
  </style>

  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#ffffff">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="apple-touch-icon" href="/static/scandroid.png">
</head>
<body>

<header>
  <div class="header-left">
    <img src="{{ url_for('static', filename='ns1.png') }}" alt="NS1">
    <img src="{{ url_for('static', filename='ns2.png') }}" alt="NS2">
  </div>

  <div class="scandroid-banner">
    <img src="{{ url_for('static', filename='scandroid_banner.png') }}" alt="Scandroid">
  </div>

  <div class="right-controls">
    <!-- status pill -->
    <span id="netStatus" class="status-pill offline">{{ (t.offline or 'Offline') }}</span>

    <form method="get" action="/fsp-admin">
      <select name="lang" onchange="this.form.submit()">
        <option value="en" {% if lang == 'en' %}selected{% endif %}>English</option>
        <option value="fr" {% if lang == 'fr' %}selected{% endif %}>Fran√ßais</option>
        <option value="ar" {% if lang == 'ar' %}selected{% endif %}>ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
      </select>
    </form>

    <form method="get" action="/fsp-logout">
      <button type="submit" class="logout-button">{{ t.logout or "Logout" }}</button>
    </form>
  </div>
</header>

<main>
  <div id="offline-popup">
    <button onclick="closeOfflinePopup()" aria-label="Close popup">&times;</button>
    ‚ö†Ô∏è {{ t.must_be_online or "You must be online to perform this action." }}
  </div>

  <!-- Last synced bar -->
  <div id="lastSyncedBar" class="last-synced-card">
    Last synced: <span id="lastSyncedText">Not synced yet</span>
  </div>

  <div class="sync-section">
    <h2>{{ t.fsp_sync_title or "üì• FSP: Sync Offline Records" }}</h2>
    <button id="syncBtn">Step 1. Sync &amp; Import</button>
    <button id="scanBtn" onclick="location.href='/scan?lang={{ lang }}'">
      {{ t.step3 or "Step 3. Scan QR Codes" }}
    </button>
    <div id="statusMessage">
      {{ t.sync_initial or "Click sync to see how many beneficiaries are ready for offline validation." }}
    </div>
  </div>

  <!-- üîπ Unified Payments Sync Card -->
  <div class="sync-section" style="margin-top: 30px;">

    <h2 style="margin-bottom: 20px;">
      {{ t.payment_prep }}
    </h2>

    <!-- Payment count -->
    <p id="csv-status" style="margin-bottom: 10px;">
      {{ t.payments_ready }}
      <span id="csv-count">0</span>
    </p>

    <!-- Step 4 button -->
    <button id="generateCsvBtn">
      {{ t.generate_csv }}
    </button>

    <!-- Step 5 button -->
    <button id="submitCsvBtn">
      {{ t.send_payments }}
    </button>

    <!-- Status message -->
    <p id="submit-status" style="font-size: 16px; margin-top: 10px;"></p>

  </div>
</main>

<footer>
  <div class="footer-left">{{ t.footer_dev }}</div>
  <div class="footer-right">{{ t.footer_support }}</div>
</footer>

<script>
  // JINJA TEMPLATE VARIABLE
  const t = {{ t | tojson | safe }};
</script>

<!-- IndexedDB helper -->
<script src="https://cdn.jsdelivr.net/npm/idb@7/build/umd.js"></script>
<!-- ZIP helper -->
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<script>
  const ONLINE_TEXT = "{{ t.online or 'Online' }}";
  const OFFLINE_TEXT = "{{ t.offline or 'Offline' }}";

  // -----------------------------
  // UPDATED SYNC BUTTON HANDLER
  // -----------------------------
  document.getElementById("syncBtn").addEventListener("click", async function () {
    if (!navigator.onLine) {
      showOfflineWarningTemporarily();
      return;
    }

    const btn = this;
    const statusDiv = document.getElementById("statusMessage");

    // show spinner + disable
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> Syncing‚Ä¶';

    try {
      // STEP 1 ‚Äî SYNC WITH SERVER
      const syncRes = await fetch("/sync-fsp?lang={{ lang }}");
      const syncJson = await syncRes.json();
      const syncMessage = syncJson.message || "Synced";

      statusDiv.textContent = syncMessage + " ‚Üí Importing‚Ä¶";

      // STEP 2 ‚Äî IMPORT LATEST CACHE SILENTLY
      const importResult = await importLatestCache(true);

      const finalMessage =
        `Sync complete: ${syncMessage} ‚Üí Imported ${importResult.written} beneficiaries and ${importResult.photosWritten} photos.`;

      // FINAL COMBINED MESSAGE
      statusDiv.textContent = "‚úÖ " + finalMessage;

      // UPDATE LAST SYNCED BAR
      // UPDATE LAST SYNCED BAR WITH COUNT
      const now = new Date();

      function formatDate(d) {
        const dd = String(d.getDate()).padStart(2, "0");
        const mm = String(d.getMonth() + 1).padStart(2, "0");
        const yyyy = d.getFullYear();
        const hh = String(d.getHours()).padStart(2, "0");
        const min = String(d.getMinutes()).padStart(2, "0");
        return `${dd}/${mm}/${yyyy} ${hh}:${min}`;
      }

      const formatted = formatDate(now);

      // Combine into full summary including count
      const syncSummary = `${formatted} ¬∑ ${importResult.written} beneficiaries`;

      const lastSyncedEl = document.getElementById("lastSyncedText");
      if (lastSyncedEl) lastSyncedEl.textContent = syncSummary;

      // Save to localStorage exactly as displayed
      localStorage.setItem("scandroid_last_synced", syncSummary);


    } catch (err) {
      console.error(err);
      statusDiv.textContent = "‚ùå Failed to sync & import. Please try again.";
    }

    btn.disabled = false;
    btn.textContent = "Step 1. Sync & Import";
  });

  // Service worker
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/service-worker.js?v=2', { updateViaCache: 'none' }).catch(()=>{});
    });
  }

  // Online detection -> update status pill
  const pill = document.getElementById('netStatus');
  function setOnlineState(isOnline) {
    pill.textContent = isOnline ? ONLINE_TEXT : OFFLINE_TEXT;
    pill.classList.toggle('online', isOnline);
    pill.classList.toggle('offline', !isOnline);
  }

  async function pingWithTimeout(timeoutMs = 2000) {
    const controller = new AbortController();
    const timer = setTimeout(() => controller.abort(), timeoutMs);
    try {
      const res = await fetch('/ping', { cache: 'no-store', signal: controller.signal });
      clearTimeout(timer);
      return res.ok;
    } catch {
      clearTimeout(timer);
      return false;
    }
  }

  async function checkOnline() {
    const ok = await pingWithTimeout(2000);
    setOnlineState(ok);
  }

  checkOnline();
  setInterval(checkOnline, 30000);
  window.addEventListener('online', () => setOnlineState(true));
  window.addEventListener('offline', () => setOnlineState(false));
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.getRegistration().then(reg => reg && reg.update());
  }
</script>

<script>
  // ---------- IndexedDB ----------
  async function openScandroidDB() {
    return await idb.openDB('scandroid', 13, {
      upgrade(db) {
        if (!db.objectStoreNames.contains('records')) db.createObjectStore('records', { keyPath: 'uuid' });
        if (!db.objectStoreNames.contains('photos'))  db.createObjectStore('photos',  { keyPath: 'uuid' });
        if (!db.objectStoreNames.contains('meta'))    db.createObjectStore('meta',    { keyPath: 'key' });
        if (!db.objectStoreNames.contains('decisions')) db.createObjectStore('decisions', { keyPath: 'uuid' });
        if (!db.objectStoreNames.contains('transaction')) db.createObjectStore('transaction', { keyPath: 'uuid' });
        if (!db.objectStoreNames.contains('payments')) db.createObjectStore('payments', { keyPath: 'uuid' });
      }
    });
  }

  const chunk = (arr, size) =>
    Array.from({ length: Math.ceil(arr.length / size) }, (_, i) => arr.slice(i * size, i * size + size));

  const findJsonEntry = (zip) =>
    Object.values(zip.files).find(f => /registrations_cache\.json$/i.test(f.name)) || null;

  const listPhotoEntries = (zip) =>
    Object.values(zip.files).filter(f => /\.enc$/i.test(f.name));

  // -----------------------------------------------------
  // UPDATED importLatestCache() SUPPORTS SILENT MODE + RETURNS COUNTS
  // -----------------------------------------------------
  async function importLatestCache(silent = false) {
    if (!navigator.onLine) {
      if (!silent) showOfflineWarningTemporarily();
      return { written: 0, photosWritten: 0 };
    }

    const statusDiv = document.getElementById('statusMessage');

    try {
      const res = await fetch('/api/offline/latest.zip', { cache: 'no-store' });
      if (!res.ok) throw new Error(`Fetch latest.zip failed: ${res.status}`);
      const zipBlob = await res.blob();
      const zip = await JSZip.loadAsync(zipBlob);

      const jsonEntry = findJsonEntry(zip);
      if (!jsonEntry) throw new Error('registrations_cache.json not found in ZIP');
      const jsonText = await jsonEntry.async('string');
      const records = JSON.parse(jsonText) || [];

      const db = await openScandroidDB();

      // Import records
      let written = 0;
      for (const group of chunk(records, 50)) {
        await Promise.all(group.map(async rec => {
          const uuid = rec.uuid || rec._uuid;
          if (!uuid) return;
          await db.put('records', rec);
          written++;
        }));
      }

      // Import photos
      const photos = listPhotoEntries(zip);
      let photosWritten = 0;
      for (const group of chunk(photos, 10)) {
        const items = await Promise.all(group.map(async entry => {
          const m = entry.name.match(/([^/\\]+)\.enc$/i);
          const uuid = m ? m[1] : null;
          if (!uuid) return null;
          const buf = await entry.async('arraybuffer');
          return { uuid, bytes: new Uint8Array(buf) };
        }));
        await Promise.all(items.filter(Boolean).map(item => db.put('photos', item)));
        photosWritten += items.filter(Boolean).length;
      }

      if (!silent) {
        statusDiv.textContent =
          `‚úÖ ${written} beneficiaries ¬∑ ${photosWritten} photos imported.`;
      }

      await db.put('meta', {
        key: 'batchInfo',
        value: { importedAt: Date.now(), recordCount: written, photos: photosWritten }
      });

      // RETURN COUNTS
      return { written, photosWritten };

    } catch (err) {
      console.error(err);
      if (!silent) {
        statusDiv.textContent = `‚ùå Import failed: ${err.message || err}`;
      }
      return { written: 0, photosWritten: 0 };
    }
  }

  // (old importBtn listener removed)
  // document.getElementById('importBtn').addEventListener('click', importLatestCache);
</script>

<script>
  function showOfflineWarningTemporarily() {
    const popup = document.getElementById('offline-popup');
    popup.style.display = 'block';
    setTimeout(() => {
      popup.style.display = 'none';
    }, 3000);
  }

  const generateCsvBtn = document.getElementById('generateCsvBtn');
  const submitCsvBtn = document.getElementById('submitCsvBtn');
  const csvCountEl = document.getElementById('csv-count');
  const submitStatus = document.getElementById('submit-status');
  let cachedCsvBlob = null;

  async function loadPaymentsAndCount() {
    const db = await openScandroidDB();
    if (!db.objectStoreNames.contains('payments')) return 0;

    const tx = db.transaction('payments', 'readonly');
    const store = tx.objectStore('payments');
    const allPayments = await store.getAll();
    csvCountEl.textContent = allPayments.length;
    return allPayments;
  }

  // Decrypt helper
  async function decrypt(encrypted, keyHex) {
    try {
      const key = await crypto.subtle.importKey(
        "raw",
        hexToBytes(keyHex),
        "AES-GCM",
        false,
        ["decrypt"]
      );

      const data = atob(encrypted);
      const iv = Uint8Array.from(data.slice(0, 12), c => c.charCodeAt(0));
      const ciphertext = Uint8Array.from(data.slice(12), c => c.charCodeAt(0));
      const decrypted = await crypto.subtle.decrypt({ name: "AES-GCM", iv }, key, ciphertext);
      return new TextDecoder().decode(decrypted);
    } catch (err) {
      console.error("Decryption failed:", err);
      return encrypted;
    }
  }

  function hexToBytes(hex) {
    return new Uint8Array(hex.match(/.{1,2}/g).map(b => parseInt(b, 16)));
  }

  generateCsvBtn.addEventListener('click', async () => {
    generateCsvBtn.disabled = true;
    submitStatus.textContent = "‚è≥ Generating CSV...";

    const db = await openScandroidDB();
    const payments = await loadPaymentsAndCount();

    if (!payments.length) {
      submitStatus.textContent = "‚ö†Ô∏è No payments to export.";
      generateCsvBtn.disabled = false;
      return;
    }

    const metaTx = db.transaction('meta', 'readonly');
    const metaStore = metaTx.objectStore('meta');
    const encKeyObj = await metaStore.get('encryptionKey');
    const encKey = encKeyObj?.value || '';

    const csvRows = [['phoneNumber', 'status']];
    for (const p of payments) {
      let phone = p.match_value;
      if (encKey && phone && phone.startsWith('gAAAA')) {
        phone = await decrypt(phone, encKey);
      }
      csvRows.push([phone, p.status]);
    }

    const csvContent = csvRows.map(row => row.join(',')).join('\n');
    cachedCsvBlob = new Blob([csvContent], { type: 'text/csv' });

    submitStatus.textContent = "‚úÖ CSV ready with " + (csvRows.length - 1) + " records.";
    submitCsvBtn.disabled = false;
  });

  submitCsvBtn.addEventListener('click', async () => {
    if (!navigator.onLine) {
      showOfflineWarningTemporarily();
      return;
    }
    if (!cachedCsvBlob) {
      alert("No CSV generated yet.");
      return;
    }

    const formData = new FormData();
    formData.append('csv', cachedCsvBlob, 'payments.csv');

    submitStatus.textContent = "üì§ Sending...";
    try {
      const res = await fetch('/submit-payments', {
        method: 'POST',
        body: formData
      });

      const responseText = await res.text();
      if (!res.ok) throw new Error(responseText || "Unknown error from server");

      submitStatus.textContent =
        t.payment_submit_success || "‚úÖ Payments submitted successfully!";

      const db = await openScandroidDB();
      const tx = db.transaction('payments', 'readwrite');
      await tx.objectStore('payments').clear();

      csvCountEl.textContent = "0";
      submitCsvBtn.disabled = true;
      generateCsvBtn.disabled = false;
      cachedCsvBlob = null;
    } catch (err) {
      console.error(err);
      submitStatus.textContent =
        (t.payment_submit_failed || "‚ùå Failed to submit") + ": " + (err.message || "Unknown error");
    }
  });

  // Init on page load
  loadPaymentsAndCount();

  let popupTimeout;
  function closeOfflinePopup() {
    const popup = document.getElementById('offline-popup');
    popup.style.display = 'none';
    clearTimeout(popupTimeout);
  }

  // Load last synced time from localStorage on page load
  // Load "Last synced" summary on page load
  (function () {
    const last = localStorage.getItem("scandroid_last_synced");
    if (last) {
      const el = document.getElementById("lastSyncedText");
      if (el) el.textContent = last;
    }
  })();

</script>

</body>
</html>
