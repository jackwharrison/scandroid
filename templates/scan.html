<!DOCTYPE html>
<html lang="{{ lang }}" {% if lang == 'ar' %}dir="rtl"{% endif %}>
<head>
  <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
  <meta charset="UTF-8">
  <title>{{ t.scan_title or "Scan QR" }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    :root {
      --pad: 16px;
      --gap: 12px;
      --radius: 16px;
      --card-bg: #ffffff;
      --navy: #002855;
      --violet: #7c3aed;
      --ink: #111827;
      --muted: #6b7280;
      --line: #e5e7eb;
      --shadow-soft: 0 8px 24px rgba(0,0,0,0.06);
    }

    html, body {
      margin: 0;
      height: 100%;
    }

    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: #f3f4f6;
      color: var(--ink);
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    /* ---------- HEADER ---------- */
    header {
      background-color: var(--navy);
      padding: 12px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      color: white;
      flex-wrap: wrap;
    }

    .header-left {
      display: flex;
      align-items: center;
    }

    .header-left img {
      height: 32px;
      width: auto;
    }

    .header-title {
      flex: 1;
      display: flex;
      align-items: center;
      padding-left: 20px;
      gap: 6px;
      font-size: 1.1rem;
    }

    .title-bold       { font-weight: 800; }
    .title-divider    { opacity: 0.7; }
    .title-program    { opacity: 0.95; font-weight: 300; }

    .header-account-wrapper {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .lang-select select {
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid var(--line);
      font-weight: 600;
      cursor: pointer;
    }

    .account-btn {
      background: transparent;
      border: none;
      padding: 6px 10px;
      border-radius: 18px;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 6px;
      color: white;
    }
    .account-icon-svg    { width: 16px; height: 16px; filter: invert(100%); }
    .account-arrow-svg   { width: 12px; height: 12px; filter: invert(100%); transition: .15s; }
    .account-btn.active .account-arrow-svg { transform: rotate(180deg); }

    .account-menu {
      position: absolute;
      background: #ffffff;
      top: 48px;
      right: 0;
      min-width: 200px;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0,0,0,.15);
      padding: 10px 0;
      z-index: 2000;
    }

    .hidden { display:none; }

    .account-menu-item {
      padding: 10px 14px;
      display: block;
      color: black;
      text-decoration: none;
      font-size: 14px;
    }

    .account-menu-item:hover {
      background:#f3f4f6;
    }

    .account-menu-divider {
      border-top: 1px solid var(--line);
      margin: 6px 0;
    }

    /* ---------- BACK BUTTON ---------- */
    .page-back-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 16px;
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--navy);
      text-decoration: none;
      padding: 8px 14px;
      background: #ffffff;
      border-radius: 999px;
      border: 2px solid var(--navy);
      transition: 0.2s ease;
    }

    .page-back-btn img {
      width: 14px;
      height: 14px;
    }

    .page-back-btn:hover {
      background: #e3e8ef;
    }

    /* ---------- MAIN CARD ---------- */
    main {
      flex: 1;
      display: flex;
      justify-content: center;
      padding: 20px;
    }

    /* container so back button and card are stacked, and only this is flex item */
    .scan-container {
      width: 100%;
      max-width: 560px;
    }

    .scan-card {
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow-soft);
      width: 100%;
      max-width: 560px;
      padding: 20px;
      border: 1px solid var(--line);
      text-align: center;
    }

    .hint {
      color: var(--muted);
      font-size: 0.95rem;
      margin-top: 4px;
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 12px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 700;
      margin-top: 10px;
    }
    .online  { background:#e7f9ef; color:#0f5132; }
    .offline { background:#fdecec; color:#842029; }

    .btn-primary {
      background: var(--violet);
      color: white;
      padding: 12px 20px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      margin-top: 14px;
    }
    .btn-primary:hover { background:#6d28d9; }

    .video-wrap {
      margin-top: 20px;
      width: 100%;
      max-width: 420px;          /* nice square size */
      aspect-ratio: 1 / 1;       /* enforce square */
      background: black;
      border-radius: 14px;
      overflow: hidden;
      margin-left: auto;
      margin-right: auto;
      position: relative;
    }

    video {
      width: 100%;
      height: 100%;
      object-fit: cover;         /* fill the square, allow cropping */
      object-position: center;   /* ensure cropping is symmetrical */
    }

    #status {
      margin-top: 14px;
      font-size: 14px;
      color: var(--ink);
      min-height: 20px;
    }

    /* ---------- FOOTER ---------- */
    footer {
      background-color: var(--navy);
      color: white;
      padding: 12px 16px;
      font-size: 0.9rem;
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
    }

    @media (max-width:576px) {
      header { flex-direction: column; gap: 10px; }
      .header-title { padding-left:0; justify-content:center; }
      .header-account-wrapper { flex-direction: column; gap: 8px; }
      footer { flex-direction: column; text-align:center; gap: 8px; }
    }
  </style>
</head>

<body>

<header>
  <div class="header-left">
    <img src="/instance-static/ns1.png" alt="">
  </div>

  <div class="header-title">
    <span class="title-bold">121 Scan</span>
    <span class="title-divider">|</span>
    <span class="title-program">{{ program_title }}</span>
  </div>

  <div class="header-account-wrapper">
    <form method="get" action="/scan" class="lang-select">
      <select name="lang" onchange="this.form.submit()">
        <option value="en" {% if lang=='en' %}selected{% endif %}>English</option>
        <option value="fr" {% if lang=='fr' %}selected{% endif %}>Français</option>
        <option value="ar" {% if lang=='ar' %}selected{% endif %}>العربية</option>
      </select>
    </form>

    <div style="position:relative;">
      <button class="account-btn" onclick="toggleAccountDropdown()">
        <img src="{{ url_for('static', filename='icons/user.svg') }}" class="account-icon-svg">
        Account
        <img src="{{ url_for('static', filename='icons/arrow.svg') }}" class="account-arrow-svg">
      </button>

      <div id="account-menu" class="account-menu hidden">
        <div class="account-menu-item user-info">
          <strong>Logged in as:</strong><br>
          {{ username }}
        </div>

        <div class="account-menu-divider"></div>

        <a href="/admin-logout?lang={{ lang }}" class="account-menu-item">Logout</a>
      </div>
    </div>
  </div>
</header>

<main>
  <div class="scan-container">
    <a href="/fsp-admin?lang={{ lang }}" class="page-back-btn">
      <img src="{{ url_for('static', filename='icons/back-arrow.svg') }}">
      {{ t.back_to_dashboard or "Back" }}
    </a>

    <div class="scan-card">
      <h1>{{ t.scan_title or "Scan QR" }}</h1>
      <div class="hint">{{ t.scan_hint or "Point the camera at the QR code." }}</div>

      <span id="netStatus" class="status-pill offline">
        {{ t.offline or "Offline" }}
      </span>

      <button id="startBtn" class="btn-primary">{{ t.start_camera or "Start camera" }}</button>

      <div class="video-wrap">
        <video id="video" autoplay playsinline muted></video>
      </div>

      <div id="status">{{ t.waiting_to_start or "Waiting to start…" }}</div>
    </div>
  </div>
</main>

<footer>
  <div>{{ t.footer_dev }}</div>
  <div>{{ t.footer_support }}</div>
</footer>

<!-- Lightweight QR library -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

<!-- ========================================================= -->
<!--     FULL ORIGINAL JAVASCRIPT FROM YOUR UPLOADED FILE      -->
<!-- ========================================================= -->

<script>
/* EVERYTHING BELOW IS EXACTLY WHAT YOU PROVIDED EARLIER
   (no logic changes, just kept as-is) */

(function () {
    const statusEl = document.getElementById('status');
    const netPill  = document.getElementById('netStatus');
    const video = document.getElementById('video');
    const startBtn = document.getElementById('startBtn');
    const lang = "{{ lang }}";

    const TXT = {
      requesting: "{{ t.requesting_camera or 'Requesting camera… If prompted, tap Allow.' }}",
      denied: "{{ t.camera_denied or 'Camera permission denied or not available.' }}",
      scanning: "{{ t.scanning or 'Scanning…' }}",
      starting: "{{ t.starting_camera or 'Starting camera…' }}"
    };

    const ONLINE_TEXT  = "{{ t.online or 'Online' }}";
    const OFFLINE_TEXT = "{{ t.offline or 'Offline' }}";

    let stream = null;
    let rafId = null;
    let lastOnline = navigator.onLine;

    const setStatus = (m) => statusEl.textContent = m;

    function setOnlineState(isOnline){
      netPill.textContent = isOnline ? ONLINE_TEXT : OFFLINE_TEXT;
      netPill.classList.toggle('online', isOnline);
      netPill.classList.toggle('offline', !isOnline);
      lastOnline = isOnline;
    }

    async function dbFindRecordByAnyId(db, scannedId) {
      console.warn("[FALLBACK] dbFindRecordByAnyId called with:", scannedId);

      return new Promise((resolve) => {
        const tx = db.transaction("records", "readonly");
        const store = tx.objectStore("records");

        const req = store.getAll();

        req.onsuccess = () => {
          const all = req.result || [];
          console.warn("[FALLBACK] Scanning", all.length, "records");

          for (const r of all) {
            if (!r) continue;

            if (
              r.uuid === scannedId ||
              r.koboId === scannedId ||
              r.regId === scannedId
            ) {
              console.warn("[FALLBACK] Match found:", r);
              resolve(r);
              return;
            }
          }

          console.warn("[FALLBACK] No record matched in getAll()");
          resolve(null);
        };

        req.onerror = () => {
          console.warn("[FALLBACK] IndexedDB getAll error");
          resolve(null);
        };
      });
    }

    async function dbCheckAlreadyScanned(db, scannedId) {
      console.warn("[PAYMENT CHECK] Checking payments store for UUID:", scannedId);

      return new Promise((resolve) => {
        const tx = db.transaction("payments", "readonly");
        const store = tx.objectStore("payments");

        const req = store.getAll();
        req.onsuccess = () => {
          const list = req.result || [];
          console.warn("[PAYMENT CHECK] Loaded", list.length, "payment records");

          for (const p of list) {
            if (!p) continue;

            if (p.uuid === scannedId && (p.status === "success" || p.status === "submitted")) {
                console.warn("[PAYMENT CHECK] Already processed:", p);
                resolve(p);
                return;
            }

          }
          resolve(null);
        };

        req.onerror = () => {
          console.warn("[PAYMENT CHECK] Error reading payments store");
          resolve(null);
        };
      });
    }

    async function checkAndRouteRecord(scannedId) {
      console.warn("[CHECK] checkAndRouteRecord() called with:", scannedId);

      const dbReq = indexedDB.open("scandroid");

      dbReq.onsuccess = async function () {
        const db = dbReq.result;
        let rec = null;

        console.warn("[CHECK] DB opened successfully");

        console.warn("[CHECK] Step 1: Looking up record by direct UUID:", scannedId);
        rec = await new Promise((resolve) => {
          const tx = db.transaction("records", "readonly");
          const store = tx.objectStore("records");
          const req = store.get(String(scannedId));
          req.onsuccess = () => {
            console.warn("[CHECK] Direct lookup result:", req.result);
            resolve(req.result);
          };
          req.onerror = () => resolve(null);
        });

        if (!rec) {
          console.warn("[CHECK] Step 2: Not found. Checking idIndex…");

          const tx = db.transaction("meta", "readonly");
          const metaStore = tx.objectStore("meta");
          const indexReq = metaStore.get("idIndex");

          const idx = await new Promise((resolve) => {
            indexReq.onsuccess = () => {
              console.warn("[CHECK] Loaded idIndex:", indexReq.result);
              resolve(indexReq.result?.value || {});
            };
            indexReq.onerror = () => resolve({});
          });

          const mapped =
            idx['uuid:' + scannedId] ||
            idx['reg:' + scannedId] ||
            idx['kobo:' + scannedId];

          console.warn("[CHECK] Mapped ID from idIndex:", mapped);

          if (mapped) {
            rec = await new Promise((resolve) => {
              const tx2 = db.transaction("records", "readonly");
              const store2 = tx2.objectStore("records");
              const getMapped = store2.get(mapped);
              getMapped.onsuccess = () => {
                console.warn("[CHECK] Record loaded via idIndex:", getMapped.result);
                resolve(getMapped.result);
              };
              getMapped.onerror = () => resolve(null);
            });
          }
        }

        if (!rec) {
          console.warn("[CHECK] Step 3: Trying fallback dbFindRecordByAnyId");
          rec = await dbFindRecordByAnyId(db, scannedId);
          console.warn("[CHECK] Fallback lookup result:", rec);
        }

        if (!rec) {
          console.warn("[CHECK] ❌ No offline record found for:", scannedId);

          const url = `/invalid-qr?reason=${encodeURIComponent(
            "No offline record found"
          )}&lang=${encodeURIComponent(lang)}`;

          console.warn("[CHECK] Redirecting to:", url);

          setTimeout(() => {
            window.location.assign(url);
            try { cleanup(); } catch (_) {}
          }, 50);

          return;
        }

        const already = await dbCheckAlreadyScanned(db, scannedId);
        if (already) {
          console.warn("[SCAN DEBUG] QR already scanned in this session:", scannedId);

          const url = `/invalid-qr?reason=${encodeURIComponent("Already scanned")}&lang=${encodeURIComponent(lang)}`;

          setTimeout(() => {
              window.location.assign(url);
              try { cleanup(); } catch(_) {}
          }, 50);

          return;
        }

        console.warn("[CHECK] Record FOUND:", rec);

        const isValid = String(rec.valid).toLowerCase() === "true";
        console.warn("[CHECK] Record validity:", isValid);

        if (!isValid) {
          console.warn("[CHECK] ❌ Record marked INVALID:", rec);

          const reason = rec.reason || "Invalid QR";
          const url = `/invalid-qr?reason=${encodeURIComponent(
            reason
          )}&lang=${encodeURIComponent(lang)}`;

          console.warn("[CHECK] Redirecting invalid record to:", url);

          window.location.href = url;
          setTimeout(() => cleanup(), 300);
          return;
        }

        console.warn("[CHECK] ✅ Valid record — redirecting to beneficiary page:", rec.uuid);

        window.location.href =
          `/beneficiary-offline?uuid=${encodeURIComponent(
            rec.uuid
          )}&lang=${encodeURIComponent(lang)}`;
      };

      dbReq.onerror = function () {
        console.warn("[CHECK] ❌ IndexedDB error opening scandroid DB");
        window.location.href = `/invalid-qr?reason=${encodeURIComponent(
          "Database error"
        )}&lang=${encodeURIComponent(lang)}`;
      };
    }

    function routeAfterScan(id) {
      const v = String(id || '').trim();
      console.warn("[ROUTER] routeAfterScan called with:", v);

      if (!v) {
        console.error("[ROUTER] Empty QR value!");
        return;
      }

      checkAndRouteRecord(v);
    }

    async function startCamera() {
      setStatus(TXT.requesting);
      try {
        stream = await navigator.mediaDevices.getUserMedia({
          audio: false,
          video: { facingMode: { ideal: 'environment' }, width: { ideal: 1280 }, height: { ideal: 720 } }
        });
      } catch (e) {
        console.error(e);
        setStatus(TXT.denied);
        return;
      }
      video.srcObject = stream;

      const onReady = () => {
        video.removeEventListener('playing', onReady);
        video.removeEventListener('canplay', onReady);
        startDecoding();
      };
      video.addEventListener('playing', onReady, { once: true });
      video.addEventListener('canplay', onReady, { once: true });
      try { await video.play(); } catch (_) {}
    }

    async function startDecoding() {
      setStatus(TXT.scanning);

      if ('BarcodeDetector' in window) {
        try {
          const detector = new window.BarcodeDetector({ formats: ['qr_code'] });
          return loopNative(detector);
        } catch (e) {
          console.warn('BarcodeDetector init failed, falling back to jsQR', e);
        }
      }
      loopJsQR();
    }

    function loopNative(detector) {
      const tick = async () => {
        try {
          const codes = await detector.detect(video);
          if (codes && codes.length) {
              console.warn("[NATIVE] QR detected:", codes);

              const v = codes[0].rawValue || codes[0].value || '';
              console.warn("[NATIVE] Extracted value:", v);

              cleanup();
              if (v) return routeAfterScan(v);
              console.error("[NATIVE] QR detected but no readable value");
          }
          setStatus(TXT.scanning);
        } catch (e) {
          console.warn('BarcodeDetector detect error; switching to jsQR', e);
          return loopJsQR();
        }
        rafId = requestAnimationFrame(tick);
      };
      rafId = requestAnimationFrame(tick);
    }

    function loopJsQR() {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d', { willReadFrequently: true });

      const tick = () => {
        if (video.readyState >= 2) {
          const w = Math.min(640, video.videoWidth || 640);
          const h = Math.floor(w * (video.videoHeight || 480) / (video.videoWidth || 640));
          canvas.width = w; canvas.height = h;
          ctx.drawImage(video, 0, 0, w, h);
          const img = ctx.getImageData(0, 0, w, h);
          const qr = jsQR(img.data, w, h, { inversionAttempts: 'dontInvert' });
          if (qr && qr.data) {
              console.warn("[JSQR] QR detected:", qr.data);
              cleanup();
              return routeAfterScan(qr.data);
          }
          setStatus(TXT.scanning);
        } else {
          setStatus(TXT.starting);
        }
        rafId = requestAnimationFrame(tick);
      };
      rafId = requestAnimationFrame(tick);
    }

    function cleanup() {
      if (rafId) cancelAnimationFrame(rafId);
      try { stream && stream.getTracks().forEach(t => t.stop()); } catch(_) {}
    }

    async function pingWithTimeout(timeoutMs = 2000) {
      const controller = new AbortController();
      const timeout = setTimeout(() => controller.abort(), timeoutMs);
      try {
        const res = await fetch('/ping', { cache: 'no-store', signal: controller.signal });
        clearTimeout(timeout);
        return res.ok;
      } catch {
        clearTimeout(timeout);
        return false;
      }
    }

    async function checkOnline() {
      const ok = await pingWithTimeout(2000);
      setOnlineState(ok);
    }

    checkOnline();
    setInterval(checkOnline, 5000);
    window.addEventListener('online', () => setOnlineState(true));
    window.addEventListener('offline', () => setOnlineState(false));

    startBtn.addEventListener('click', startCamera);
    window.addEventListener('beforeunload', cleanup);
  })();
</script>

<script>
function toggleAccountDropdown() {
  const menu = document.getElementById("account-menu");
  const btn  = document.querySelector(".account-btn");
  menu.classList.toggle("hidden");
  btn.classList.toggle("active");
}

document.addEventListener("click", function(e){
  const menu = document.getElementById("account-menu");
  const btn  = document.querySelector(".account-btn");
  if (!btn.contains(e.target)) {
    menu.classList.add("hidden");
    btn.classList.remove("active");
  }
});
</script>

</body>
</html>
