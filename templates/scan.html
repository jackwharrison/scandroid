<!DOCTYPE html>
<html lang="{{ lang }}" {% if lang == 'ar' %}dir="rtl"{% endif %}>
<head>
  <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
  <meta charset="UTF-8">
  <title>{{ t.scan_title or "Scan QR" }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    :root {
      --pad: 16px;
      --gap: 12px;
      --radius: 16px;
      --card-bg: #ffffff;
      --navy: #002855;
      --violet: #7c3aed;
      --ink: #111827;
      --muted: #6b7280;
      --line: #e5e7eb;
      --shadow-soft: 0 8px 24px rgba(0,0,0,0.06);
    }

    html, body {
      margin: 0;
      height: 100%;
    }

    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: #f3f4f6;
      color: var(--ink);
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    /* ---------- HEADER ---------- */
    header {
      background-color: var(--navy);
      padding: 12px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      color: white;
      flex-wrap: wrap;
    }

    .header-left {
      display: flex;
      align-items: center;
    }

    .header-left img {
      height: 32px;
      width: auto;
    }

    .header-title {
      flex: 1;
      display: flex;
      align-items: center;
      padding-left: 20px;
      gap: 6px;
      font-size: 1.1rem;
    }

    .title-bold       { font-weight: 800; }
    .title-divider    { opacity: 0.7; }
    .title-program    { opacity: 0.95; font-weight: 300; }

    .header-account-wrapper {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .lang-select select {
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid var(--line);
      font-weight: 600;
      cursor: pointer;
    }

    .account-btn {
      background: transparent;
      border: none;
      padding: 6px 10px;
      border-radius: 18px;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 6px;
      color: white;
    }
    .account-icon-svg    { width: 16px; height: 16px; filter: invert(100%); }
    .account-arrow-svg   { width: 12px; height: 12px; filter: invert(100%); transition: .15s; }
    .account-btn.active .account-arrow-svg { transform: rotate(180deg); }

    .account-menu {
      position: absolute;
      background: #ffffff;
      top: 48px;
      right: 0;
      min-width: 200px;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0,0,0,.15);
      padding: 10px 0;
      z-index: 2000;
    }

    .hidden { display:none; }

    .account-menu-item {
      padding: 10px 14px;
      display: block;
      color: black;
      text-decoration: none;
      font-size: 14px;
    }

    .account-menu-item:hover {
      background:#f3f4f6;
    }

    .account-menu-divider {
      border-top: 1px solid var(--line);
      margin: 6px 0;
    }

    /* ---------- BACK BUTTON ---------- */
    .page-back-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 16px;
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--navy);
      text-decoration: none;
      padding: 8px 14px;
      background: #ffffff;
      border-radius: 999px;
      border: 2px solid var(--navy);
      transition: 0.2s ease;
    }

    .page-back-btn img {
      width: 14px;
      height: 14px;
    }

    .page-back-btn:hover {
      background: #e3e8ef;
    }

    /* ---------- MAIN CARD ---------- */
    main {
      flex: 1;
      display: flex;
      justify-content: center;
      padding: 20px;
    }

    /* container so back button and card are stacked, and only this is flex item */
    .scan-container {
      width: 100%;
      max-width: 560px;
    }

    .scan-card {
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow-soft);
      width: 100%;
      max-width: 560px;
      padding: 20px;
      border: 1px solid var(--line);
      text-align: center;
    }

    .hint {
      color: var(--muted);
      font-size: 0.95rem;
      margin-top: 4px;
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 12px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 700;
      margin-top: 10px;
    }
    .online  { background:#e7f9ef; color:#0f5132; }
    .offline { background:#fdecec; color:#842029; }

    .btn-primary {
      background: var(--violet);
      color: white;
      padding: 12px 20px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      margin-top: 14px;
    }
    .btn-primary:hover { background:#6d28d9; }

    .video-wrap {
      margin-top: 20px;
      width: 100%;
      max-width: 420px;          /* nice square size */
      aspect-ratio: 1 / 1;       /* enforce square */
      background: black;
      border-radius: 14px;
      overflow: hidden;
      margin-left: auto;
      margin-right: auto;
      position: relative;
    }

    video {
      width: 100%;
      height: 100%;
      object-fit: cover;         /* fill the square, allow cropping */
      object-position: center;   /* ensure cropping is symmetrical */
    }

    #status {
      margin-top: 14px;
      font-size: 14px;
      color: var(--ink);
      min-height: 20px;
    }

    /* ---------- FOOTER ---------- */
    footer {
      background-color: var(--navy);
      color: white;
      padding: 12px 16px;
      font-size: 0.9rem;
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
    }

    @media (max-width:576px) {
      header { flex-direction: column; gap: 10px; }
      .header-title { padding-left:0; justify-content:center; }
      .header-account-wrapper { flex-direction: column; gap: 8px; }
      footer { flex-direction: column; text-align:center; gap: 8px; }
    }
  </style>
</head>

<body>

<header>
  <div class="header-left">
    <img src="/instance-static/ns1.png" alt="">
  </div>

  <div class="header-title">
    <span class="title-bold">121 Scan</span>
    <span class="title-divider">|</span>
    <span class="title-program">{{ program_title }}</span>
  </div>

  <div class="header-account-wrapper">
    <form method="get" action="/scan" class="lang-select">
      <select name="lang" onchange="this.form.submit()">
        <option value="en" {% if lang=='en' %}selected{% endif %}>English</option>
        <option value="fr" {% if lang=='fr' %}selected{% endif %}>Français</option>
        <option value="ar" {% if lang=='ar' %}selected{% endif %}>العربية</option>
      </select>
    </form>

    <div style="position:relative;">
      <button class="account-btn" onclick="toggleAccountDropdown()">
        <img src="{{ url_for('static', filename='icons/user.svg') }}" class="account-icon-svg">
        Account
        <img src="{{ url_for('static', filename='icons/arrow.svg') }}" class="account-arrow-svg">
      </button>

      <div id="account-menu" class="account-menu hidden">
        <div class="account-menu-item user-info">
          <strong>Logged in as:</strong><br>
          {{ username }}
        </div>

        <div class="account-menu-divider"></div>

        <a href="/admin-logout?lang={{ lang }}" class="account-menu-item">Logout</a>
      </div>
    </div>
  </div>
</header>

<main>
  <div class="scan-container">
    <a href="/fsp-admin?lang={{ lang }}" class="page-back-btn">
      <img src="{{ url_for('static', filename='icons/back-arrow.svg') }}">
      {{ t.back_to_dashboard or "Back" }}
    </a>

    <div class="scan-card">
      <h1>{{ t.scan_title or "Scan QR" }}</h1>
      <div class="hint">{{ t.scan_hint or "Point the camera at the QR code." }}</div>

      <span id="netStatus" class="status-pill offline">
        {{ t.offline or "Offline" }}
      </span>

      <button id="startBtn" class="btn-primary">{{ t.start_camera or "Start camera" }}</button>

      <div class="video-wrap">
        <video id="video" autoplay playsinline muted></video>
      </div>

      <div id="status">{{ t.waiting_to_start or "Waiting to start…" }}</div>
    </div>
  </div>
</main>

<footer>
  <div>{{ t.footer_dev }}</div>
  <div>{{ t.footer_support }}</div>
</footer>

<!-- Lightweight QR library -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

<!-- ========================================================= -->
<!--     FULL ORIGINAL JAVASCRIPT FROM YOUR UPLOADED FILE      -->
<!-- ========================================================= -->
<script>
document.addEventListener("DOMContentLoaded", () => {

  (function () {
    const statusEl = document.getElementById('status');
    const netPill  = document.getElementById('netStatus');
    const video = document.getElementById('video');
    const startBtn = document.getElementById('startBtn');
    const lang = "{{ lang }}";

    const TXT = {
      requesting: "{{ t.requesting_camera or 'Requesting camera… If prompted, tap Allow.' }}",
      denied: "{{ t.camera_denied or 'Camera permission denied or not available.' }}",
      scanning: "{{ t.scanning or 'Scanning…' }}",
      starting: "{{ t.starting_camera or 'Starting camera…' }}"
    };

    const ONLINE_TEXT  = "{{ t.online or 'Online' }}";
    const OFFLINE_TEXT = "{{ t.offline or 'Offline' }}";

    let stream = null;
    let rafId = null;

    const setStatus = (m) => {
      if (statusEl) statusEl.textContent = m;
    };

    function setOnlineState(isOnline) {
      if (!netPill) return;
      netPill.textContent = isOnline ? ONLINE_TEXT : OFFLINE_TEXT;
      netPill.classList.toggle('online', isOnline);
      netPill.classList.toggle('offline', !isOnline);
    }

    /* ---------- OFFLINE / ONLINE CHECK ---------- */

    async function pingWithTimeout(timeoutMs = 2000) {
      const controller = new AbortController();
      const timer = setTimeout(() => controller.abort(), timeoutMs);
      try {
        const res = await fetch('/ping', { cache: 'no-store', signal: controller.signal });
        clearTimeout(timer);
        return res.ok;
      } catch {
        clearTimeout(timer);
        return false;
      }
    }

    async function checkOnline() {
      const ok = await pingWithTimeout();
      setOnlineState(ok);
    }

    checkOnline();
    setInterval(checkOnline, 5000);
    window.addEventListener('online',  () => setOnlineState(true));
    window.addEventListener('offline', () => setOnlineState(false));

    /* ---------- DB HELPERS ---------- */

    async function dbFindRecordByAnyId(db, scannedId) {
      return new Promise((resolve) => {
        const tx = db.transaction("records", "readonly");
        const store = tx.objectStore("records");
        const req = store.getAll();

        req.onsuccess = () => {
          const all = req.result || [];
          for (const r of all) {
            if (
              r &&
              (r.uuid === scannedId ||
               r.koboId === scannedId ||
               r.regId === scannedId)
            ) {
              resolve(r);
              return;
            }
          }
          resolve(null);
        };

        req.onerror = () => resolve(null);
      });
    }

    async function dbCheckAlreadyScanned(db, scannedId) {
      return new Promise((resolve) => {
        const tx = db.transaction("payments", "readonly");
        const store = tx.objectStore("payments");
        const req = store.getAll();

        req.onsuccess = () => {
          const list = req.result || [];
          for (const p of list) {
            if (
              p &&
              p.uuid === scannedId &&
              (p.status === "success" || p.status === "submitted")
            ) {
              resolve(p);
              return;
            }
          }
          resolve(null);
        };

        req.onerror = () => resolve(null);
      });
    }

    /* ---------- ROUTING ---------- */

    async function checkAndRouteRecord(scannedId) {
      const dbReq = indexedDB.open("scandroid");

      dbReq.onsuccess = async () => {
        const db = dbReq.result;
        let rec = null;

        // Direct lookup
        rec = await new Promise((resolve) => {
          const tx = db.transaction("records", "readonly");
          const store = tx.objectStore("records");
          const req = store.get(String(scannedId));
          req.onsuccess = () => resolve(req.result);
          req.onerror = () => resolve(null);
        });

        // idIndex fallback
        if (!rec) {
          const idx = await new Promise((resolve) => {
            const tx = db.transaction("meta", "readonly");
            const store = tx.objectStore("meta");
            const req = store.get("idIndex");
            req.onsuccess = () => resolve(req.result?.value || {});
            req.onerror = () => resolve({});
          });

          const mapped =
            idx['uuid:' + scannedId] ||
            idx['reg:' + scannedId] ||
            idx['kobo:' + scannedId];

          if (mapped) {
            rec = await new Promise((resolve) => {
              const tx = db.transaction("records", "readonly");
              const store = tx.objectStore("records");
              const req = store.get(mapped);
              req.onsuccess = () => resolve(req.result);
              req.onerror = () => resolve(null);
            });
          }
        }

        // brute-force fallback
        if (!rec) rec = await dbFindRecordByAnyId(db, scannedId);

        if (!rec) {
          window.location.href =
            `/invalid-qr?reason=${encodeURIComponent("No offline record found")}&lang=${lang}`;
          cleanup();
          return;
        }

        const already = await dbCheckAlreadyScanned(db, scannedId);
        if (already) {
          window.location.href =
            `/invalid-qr?reason=${encodeURIComponent("Already scanned")}&lang=${lang}`;
          cleanup();
          return;
        }

        const isValid = String(rec.valid).toLowerCase() === "true";
        if (!isValid) {
          const reason = rec.reason || "Invalid QR";
          window.location.href =
            `/invalid-qr?reason=${encodeURIComponent(reason)}&lang=${lang}`;
          cleanup();
          return;
        }

        window.location.href =
          `/beneficiary-offline?uuid=${encodeURIComponent(rec.uuid)}&lang=${lang}`;
      };

      dbReq.onerror = () => {
        window.location.href =
          `/invalid-qr?reason=${encodeURIComponent("Database error")}&lang=${lang}`;
      };
    }

    function routeAfterScan(value) {
      const v = String(value || '').trim();
      if (!v) return;
      checkAndRouteRecord(v);
    }

    /* ---------- CAMERA + SCAN ---------- */

    async function startCamera() {
      setStatus(TXT.requesting);
      try {
        stream = await navigator.mediaDevices.getUserMedia({
          audio: false,
          video: { facingMode: { ideal: 'environment' } }
        });
      } catch {
        setStatus(TXT.denied);
        return;
      }

      video.srcObject = stream;
      try { await video.play(); } catch {}

      startDecoding();
    }

    async function startDecoding() {
      setStatus(TXT.scanning);

      if ('BarcodeDetector' in window) {
        try {
          const detector = new BarcodeDetector({ formats: ['qr_code'] });
          return loopNative(detector);
        } catch {}
      }

      loopJsQR();
    }

    function loopNative(detector) {
      const tick = async () => {
        try {
          const codes = await detector.detect(video);
          if (codes?.length) {
            cleanup();
            return routeAfterScan(codes[0].rawValue || '');
          }
        } catch {
          return loopJsQR();
        }
        rafId = requestAnimationFrame(tick);
      };
      rafId = requestAnimationFrame(tick);
    }

    function loopJsQR() {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d', { willReadFrequently: true });

      const tick = () => {
        if (video.readyState >= 2) {
          canvas.width = video.videoWidth || 640;
          canvas.height = video.videoHeight || 480;
          ctx.drawImage(video, 0, 0);
          const img = ctx.getImageData(0, 0, canvas.width, canvas.height);
          const qr = jsQR(img.data, canvas.width, canvas.height);
          if (qr?.data) {
            cleanup();
            return routeAfterScan(qr.data);
          }
        }
        rafId = requestAnimationFrame(tick);
      };
      rafId = requestAnimationFrame(tick);
    }

    function cleanup() {
      if (rafId) cancelAnimationFrame(rafId);
      try { stream && stream.getTracks().forEach(t => t.stop()); } catch {}
    }

    startBtn.addEventListener('click', startCamera);
    window.addEventListener('beforeunload', cleanup);

  })();

});
</script>


</body>
</html>
